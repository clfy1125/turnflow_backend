# 프로젝트 지침서

## 0) 전체 맥락 (각 Step 실행 전, 반드시 공유해야 할 사항)

### 0-1. 목표 범위(MVP)

**MVP 1차 목표**

- 인스타 비즈 계정 연동(토큰 관리)
- 게시물 댓글 수집/분류(관심/스팸/악플 등) + 키워드 감지
- 규칙 기반 자동 DM 발송(24시간 정책 고려)
- DM 템플릿/시나리오 관리
- 성과 대시보드용 지표(발송/응답/필터링 정확도/전환 추적 기본)
- 요금제(Starter/Pro/Enterprise) 기반 사용량 제한(댓글 수집량 등)

**2차(확장)**

- LLM 기반 문맥/의도 분석, 릴스/게시물 컨텐츠 분석, DM 자동 작성 고도화
- A/B 테스트, 멀티 시나리오, 전환 퍼널 상세, CRM 연동, 웹훅/이벤트 스트림

---

### 0-2. 외부 제약(중요)

- Instagram 메시징/댓글/DM 자동화는 **공식 API 정책 및 24시간 메시징 정책(24-hour policy)** 등의 제약을 받습니다.
- Meta Graph API 사용 시:
    - **OAuth 토큰(단기/장기), 페이지/비즈니스 자산 연결**, Webhook(구독/검증), 권한 범위 승인 등 흐름이 필요합니다.
    - DM 발송은 “사용자와의 최근 상호작용/허용된 창” 등 조건이 걸릴 수 있으므로, 백엔드에 **정책 검증 레이어**를 둬야 합니다.
- 결론: 초기에 **정책/권한/승인 흐름을 “코드 구조로 분리”**해두고, 실제 운영 승인 전에도 개발/테스트가 가능하도록 **Mock 모드(샌드박스/스텁)** 를 같이 만듭니다.

---

### 0-3. 아키텍처 원칙(백엔드만)

- **API-First**: 프론트가 없어도 Postman/Swagger로 전 기능 검증 가능해야 함
- **멀티 테넌시(Workspace/Organization)**: 고객사별 데이터 분리(논리적 분리)
- **비동기 처리**: 댓글 수집, 분류, DM 발송, 지표 집계는 큐 기반(예: Celery + Redis)으로 설계
- **Idempotency/재처리**: Webhook 이벤트 중복 수신 대비(이벤트키/해시 저장)
- **관측성**: request_id, 작업(job) 상태, 실패 재시도, 감사 로그(audit) 기본 탑재
- **보안**: 토큰/개인정보 최소화, 토큰 암호화 저장, 권한/접근제어 철저

---

### 0-4. 데이터 모델(핵심 엔티티 초안)

(최소 MVP 기준; 실제 Step에서 마이그레이션으로 확정)

- **User**: 서비스 사용자
- **Workspace(Organization)**: 테넌트
- **Membership**: User-Workspace 역할(Owner/Admin/Member)
- **IGAccountConnection**: 인스타/비즈니스 계정 연결 정보(토큰/만료/스코프/상태)
- **IGMedia(Post/Reel)**: 게시물/릴스 메타
- **IGComment**: 댓글 원문/작성자/타임스탬프/미디어 연결
- **CommentClassification**: 분류 결과(approved/spam/abuse/lead 등) + 근거
- **KeywordRule**: 키워드 감지 규칙(포함/제외/정규식/우선순위)
- **AutomationScenario**: 자동화 시나리오(트리거/조건/액션)
- **DMSendAttempt**: DM 발송 시도(정책검증 결과/성공/실패/에러)
- **DMTemplate**: 템플릿(변수, 버전)
- **EventInbox(WebhookEvent)**: 웹훅 수신 원본(중복 방지, 원문 보관)
- **MetricDaily / MetricEvent**: 지표 집계(일간/이벤트성)

---

### 0-5. API 설계 원칙

- 버전 prefix: `/api/v1/`
- 인증: JWT(또는 세션+CSRF; MVP는 JWT 권장)
- 문서화: OpenAPI(Swagger) 자동 생성
- 표준 응답/에러 포맷 통일
- 레이트리밋(테넌트별), 사용량 제한(요금제별) 포함

---

### 0-6. 개발/운영 환경

- 로컬: Docker Compose (web, db, redis)
- 테스트: pytest + factory
- CI: lint/format + 테스트 + 마이그레이션 체크
- 배포: (추후) container 기반. 환경변수로 설정 분리

---

### 0-7. API 문서화 필수 규칙 (CRITICAL)

**모든 API 엔드포인트는 프론트엔드 개발자가 별도 설명 없이 즉시 이해하고 사용할 수 있도록 작성되어야 합니다.**

#### 필수 포함 사항

각 API 엔드포인트(`@extend_schema`)에는 다음 정보가 **반드시** 포함되어야 합니다:

1. **summary**: 한 줄 요약 (30자 이내)
2. **description**: 상세 설명 (다음 내용 포함)
   - API의 목적과 역할
   - 사용 시나리오 및 타이밍
   - 인증 요구사항 (토큰 필요 여부)
   - 주요 비즈니스 로직 설명
   - 주의사항 및 제약조건

3. **request**: 요청 본문 스키마 (POST/PUT/PATCH)
   - 각 필드의 설명
   - 필수/선택 여부
   - 유효성 검증 규칙
   - 예시 값

4. **responses**: 모든 가능한 응답 케이스
   - 200/201: 성공 응답 (스키마 포함)
   - 400: 유효성 검증 실패
   - 401: 인증 실패
   - 403: 권한 없음
   - 404: 리소스 없음
   - 500: 서버 오류

5. **examples**: 실제 사용 예시
   - 요청 예시 (curl, JavaScript fetch)
   - 응답 예시 (JSON)

#### 문서화 템플릿

```python
@extend_schema(
    summary="짧은 한 줄 설명",
    description="""
    ## 목적
    이 API가 무엇을 하는지 명확하게 설명
    
    ## 사용 시나리오
    - 언제 이 API를 호출해야 하는지
    - 어떤 상황에서 사용하는지
    
    ## 인증
    - Bearer 토큰 필요 여부
    - 필요한 권한
    
    ## 주의사항
    - 제약조건
    - 에러 처리 방법
    
    ## 예시
    ```javascript
    // 요청 예시
    const response = await fetch('/api/v1/endpoint', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer YOUR_ACCESS_TOKEN'
        },
        body: JSON.stringify({
            field1: 'value1',
            field2: 'value2'
        })
    });
    ```
    """,
    request=RequestSerializer,
    responses={
        200: OpenApiResponse(
            response=ResponseSerializer,
            description="성공 시 반환되는 데이터",
            examples=[
                OpenApiExample(
                    'Success Example',
                    value={
                        'field1': 'example_value',
                        'field2': 123
                    }
                )
            ]
        ),
        400: OpenApiResponse(
            description="유효성 검증 실패",
            examples=[
                OpenApiExample(
                    'Validation Error',
                    value={
                        'success': False,
                        'error': {
                            'code': 400,
                            'message': 'Validation failed',
                            'details': {
                                'field1': ['This field is required.']
                            }
                        }
                    }
                )
            ]
        ),
        401: OpenApiResponse(description="인증 실패 - 토큰이 없거나 유효하지 않음"),
    }
)
```

#### 체크리스트

새로운 API를 작성할 때 다음을 확인하세요:

- [ ] summary가 명확하고 간결한가?
- [ ] description에 목적, 시나리오, 인증, 주의사항이 포함되어 있는가?
- [ ] 요청/응답 스키마가 정의되어 있는가?
- [ ] 모든 가능한 HTTP 상태 코드가 문서화되어 있는가?
- [ ] 실제 사용 예시(JavaScript/curl)가 포함되어 있는가?
- [ ] 프론트엔드 개발자가 이 문서만 보고 구현할 수 있는가?

#### 금지 사항

- ❌ summary만 작성하고 description 생략
- ❌ "사용자 생성", "로그인" 같은 너무 간단한 설명
- ❌ 에러 응답 문서화 생략
- ❌ 인증 요구사항 명시 누락
- ❌ 실제 사용 예시 없음